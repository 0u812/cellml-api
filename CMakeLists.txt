CMAKE_MINIMUM_REQUIRED(VERSION 2.8)
SET(CMAKE_BACKWARDS_COMPATIBILITY 2.8)
MARK_AS_ADVANCED(CMAKE_BACKWARDS_COMPATIBILITY)

INCLUDE(CTest)

OPTION(ENABLE_CORBA "Generate a two-way bridge between the C++ implementation and CORBA, allowing all parts of the API to be accessed from CORBA. Note: this functionality is not widely tested; if you find a bug, we are only interested if you also provide a working patch to fix the problem")
MARK_AS_ADVANCED(FORCE ENABLE_CORBA)
OPTION(ENABLE_XPCOM "Generate XPIDL interfaces and a two-way bridge between the C++ implementation and XPCOM, allowing all parts of the API to be accessed from XPCOM. Note: this functionality is not widely tested; if you find a bug, we are only interested if you also provide a working patch to fix the problem")
OPTION(ENABLE_JAVA_BUILD "Build Java interfaces and a bridge between the C++ implementation and Java, allowing all parts of the API to be accessed from Java.")
OPTION(ENABLE_PYTHON "Build Python interfaces and a bridge between the C++ implementation and Python, allowing all parts of the API to be accessed from Python.")
MARK_AS_ADVANCED(FORCE ENABLE_XPCOM)
SET(XULRUNNER_SDK_PATH "/usr/local/xulrunner-sdk" CACHE PATH "This property is only used when XPCOM support has been enabled. It determines the path to the xulrunner SDK used to build the XPCOM bridge")
MARK_AS_ADVANCED(FORCE XULRUNNER_SDK_PATH)

OPTION(ENABLE_ANNOTOOLS "Build AnnoTools, a service for handling sets of annotations of different types against parts of models.")
OPTION(ENABLE_CCGS "Build the CellML Code Generation Service (CCGS), allowing CellML models to be translated into code in a customisable procedural language")
OPTION(ENABLE_CELEDS "Build the CellML Language Export Definition Service (CeLEDS), allowing an XML description of a translation from MathML to a text-based format to be applied to MathML")
OPTION(ENABLE_CELEDS_EXPORTER "Build the CellML Language Export Definition Exporter Service (CeLEDSExporter), allowing an XML description of a translation from CellML to a text-based format to be applied to CellML to generate procedural code")
OPTION(ENABLE_CIS "Build the CellML Integration Service, which allows simulations to be run from CellML models")
OPTION(ENABLE_CUSES "Build the CellML Units Simplification and Expansion Service (CUSES), allowing the canonicalisation and compare units in CellML models")
OPTION(ENABLE_CEVAS "Build the CellML Variable Association Service (CeVAS), allowing information on which variables are connected to be easily obtained")
OPTION(ENABLE_CONTEXT "Build the CellML Context, a service for maintaining a global list of models that are open")
OPTION(ENABLE_EXAMPLES "Build the example programs in the example subdirectory")
OPTION(ENABLE_GSL_INTEGRATORS "Build GSL integrators in CCGS (note: binaries linked against GSL contain code that is only available under the GNU GPL license)")
OPTION(ENABLE_MALAES "Build the MathML to Language Expression Service (MaLaES), allowing the translation of a MathML expressions into text in a customised form")
OPTION(ENABLE_RDF "Enable the RDF library, which provides access to RDF as triples")
OPTION(ENABLE_SPROS "Enable SProS, the SED-ML Processing Service, for manipulating and creating SED-ML descriptions of simulation experiments")
OPTION(ENABLE_SRUS "Enable SRuS, the SED-ML Running Service, for running simulations from SED-ML simulation experiments")
OPTION(ENABLE_SPROS "Enable SProS, the SED-ML Processing Service, for manipulating and creating SED-ML descriptions of simulation experiments")
OPTION(ENABLE_TELICEMS "Enable the TeLICeM (Text-based Language for the Input of CellML Models) Service")
OPTION(ENABLE_VACSS "Build the Validation Against CellML Specification Service (VACSS), allowing CellML models to be validated to detect potential or actual problems with the model")

OPTION(CHECK_BUILD "Run some basic checks on whether the build is likely to succeed before actually building" ON)
OPTION(BUILD_SHARED_LIBS "Build shared libraries" ON)

# Option Dependencies...
# These must be ordered so modules come before their dependencies.
IF (ENABLE_CELEDS_EXPORTER)
  SET(ENABLE_CELEDS ON)
  SET(ENABLE_CCGS ON)
ENDIF()
IF (ENABLE_CELEDS)
  SET(ENABLE_MALAES ON)
ENDIF()
IF (ENABLE_SRUS)
  SET(ENABLE_SPROS ON)
  SET(ENABLE_CIS ON)
ENDIF()
IF (ENABLE_GSL_INTEGRATORS)
  SET(ENABLE_CIS ON)
ENDIF()
IF (ENABLE_CIS)
  SET(ENABLE_CCGS ON)
ENDIF()
IF (ENABLE_MALAES)
  SET(ENABLE_CEVAS ON)
ENDIF()
IF (ENABLE_VACSS)
  SET(ENABLE_CUSES ON)
ENDIF()
IF (ENABLE_CUSES)
  SET(ENABLE_ANNOTOOLS ON)
ENDIF()

INCLUDE(build/idl.cmake)
INCLUDE(build/bootstraps.cmake)
INCLUDE(build/test_init.cmake)

# Now we do each module in turn (if enabled)
INCLUDE(sources/core.cmake)

IF(ENABLE_ANNOTOOLS)
  INCLUDE(AnnoTools/annotools.cmake)
ENDIF()

IF(ENABLE_CCGS)
  INCLUDE(CCGS/ccgs.cmake)
ENDIF()

IF (ENABLE_CELEDS)
ENDIF()

IF (ENABLE_CELEDS_EXPORTER)
ENDIF()

IF (ENABLE_CIS)
ENDIF()

IF (ENABLE_CUSES)
  INCLUDE(CUSES/cuses.cmake)
ENDIF()

IF (ENABLE_CEVAS)
  INCLUDE(CeVAS/cevas.cmake)
ENDIF()

IF (ENABLE_CONTEXT)
ENDIF()

IF (ENABLE_MALAES)
  INCLUDE(MaLaES/malaes.cmake)
ENDIF()

IF (ENABLE_RDF)
ENDIF()

IF (ENABLE_SPROS)
ENDIF()

IF (ENABLE_SRUS)
ENDIF()

IF (ENABLE_TELICEMS)
ENDIF()

IF (ENABLE_VACSS)
ENDIF()

# Testing...
FIND_LIBRARY(CPPUNIT cppunit)
IF(CPPUNIT STREQUAL "CPPUNIT-NOTFOUND")
  SET(HAS_CPPUNIT OFF)
ELSE()
  SET(HAS_CPPUNIT ON)
ENDIF()
INCLUDE(build/test.cmake)

# Finally, do all the language specific bits...

INCLUDE(build/cxx.cmake)

IF (ENABLE_CORBA)
  INCLUDE(build/corba.cmake)
ENDIF()

IF (ENABLE_XPCOM)
  INCLUDE(build/xpcom.cmake)
ENDIF()

IF (ENABLE_JAVA_BUILD)
  INCLUDE(build/java.cmake)
ENDIF()

IF (ENABLE_PYTHON)
  INCLUDE(build/python.cmake)
ENDIF()

IF (ENABLE_EXAMPLES)
  # To do: build and install examples.
ENDIF()

# Finally, compiler setup...
INCLUDE(CheckIncludeFile)
INCLUDE(CheckLibraryExists)
INCLUDE(CheckTypeSize)
INCLUDE(CheckCCompilerFlag)
CHECK_TYPE_SIZE(wchar_t* SIZEOF_WCHAR_TP)
CHECK_INCLUDE_FILE(inttypes.h HAVE_HEADER_INTTYPES_H)
CHECK_INCLUDE_FILE(JavaVM/jni.h HAVE_JAVAVM_JNI_H)
CHECK_INCLUDE_FILE(jni.h HAVE_JNI_H)
CHECK_LIBRARY_EXISTS(gsl gsl_permutation_alloc "" HAVE_LIBGSL)
CHECK_LIBRARY_EXISTS(gslcblas cblas_dtrmm "" HAVE_LIBGSLCBLAS)
LIST(APPEND CMAKE_EXTRA_INCLUDE_FILES "inttypes.h")
CHECK_TYPE_SIZE(int64_t SIZE_INT64_T)
CHECK_TYPE_SIZE(uint64_t SIZE_UINT64_T)
CHECK_TYPE_SIZE(int32_t SIZE_INT32_T)
CHECK_TYPE_SIZE(uint32_t SIZE_UINT32_T)
CHECK_TYPE_SIZE(int16_t SIZE_INT16_T)
CHECK_TYPE_SIZE(uint16_t SIZE_UINT16_T)
CHECK_C_COMPILER_FLAG("-fvisibility=hidden" HAVE_VISIBILITY_ATTRIBUTE)

CHECK_C_COMPILER_FLAG("-Wl,--no-undefined" HAVE_NO_UNDEFINED)
IF(HAVE_NO_UNDEFINED)
  SET_PROPERTY(GLOBAL APPEND PROPERTY LINK_FLAGS "-Wl,--no-undefined")
ENDIF()

CHECK_C_COMPILER_FLAG("-Wl,--no-allow-shlib-undefined" HAVE_NO_ALLOW_SHLIB_UNDEFINED)
IF(HAVE_NO_ALLOW_SHLIB_UNDEFINED)
  SET_PROPERTY(GLOBAL APPEND PROPERTY LINK_FLAGS "-Wl,--no-allow-shlib-undefined")
ENDIF()

CONFIGURE_FILE(cda_config.h.in cda_config.h)
